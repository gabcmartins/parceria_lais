# DADA2 pipeline for 16S rRNA gene amplicon data
# V3â€“V4 region (~470 bp), Illumina paired-end sequencing
# Samples were already demultiplexed and non-biological nucleotides removed
# Due to low merging rate, only forward reads were used in downstream analyses

library(dada2)

# Path to FASTQ files
path <- "/media/Data/gabicas/dados_vanessa/raw_data/fastq"
list.files(path)

# Organizing forward and reverse files
fnFs <- sort(list.files(path, pattern = "_1.fastq.gz", full.names = TRUE))
fnRs <- sort(list.files(path, pattern = "_2.fastq.gz", full.names = TRUE))
sample.names <- sapply(strsplit(basename(fnFs), "_"), `[`, 1)

# Plotting representative quality profiles
plotQualityProfile(fnFs[1:2])   # forward
plotQualityProfile(fnFs[6:7])   # forward
plotQualityProfile(fnRs[1:2])   # reverse
plotQualityProfile(fnRs[6:7])   # reverse

# Defining filtered files
filt_path <- file.path(path, "filtered")
dir.create(filt_path, showWarnings = FALSE)

filtFs <- file.path(filt_path, basename(fnFs))
filtRs <- file.path(filt_path, basename(fnRs))

# Filtering and trimming
out <- filterAndTrim(
  fnFs, filtFs,
  fnRs, filtRs,
  truncLen = c(210, 210),  # chosen based on quality profiles (Q > 30)
  maxN = 0,
  maxEE = c(2, 5),         # balance between read retention and error control
  truncQ = 2,
  rm.phix = TRUE,
  compress = TRUE,
  multithread = TRUE
)

# Error learning and denoising (forward reads only)
errF <- learnErrors(filtFs, multithread = TRUE)
dadaFs <- dada(filtFs, err = errF, multithread = TRUE)

# Construct sequence table (forward reads only)
seqtab <- makeSequenceTable(dadaFs)

# Inspect ASV length distribution
table(nchar(getSequences(seqtab)))

# Remove chimeric sequences
seqtab.nochim <- removeBimeraDenovo(
  seqtab,
  method = "consensus",
  multithread = TRUE,
  verbose = TRUE
)

# Proportion of non-chimeric reads
sum(seqtab.nochim) / sum(seqtab)

# Save ASV table
write.csv(seqtab.nochim, "seqtab_nochim.csv", quote = FALSE)

# Tracking reads through the pipeline
getN <- function(x) sum(getUniques(x))

track <- cbind(
  out,
  sapply(dadaFs, getN),
  rowSums(seqtab.nochim)
)

colnames(track) <- c("input", "filtered", "denoisedF", "nonchim")
rownames(track) <- sample.names

write.csv(track, "track_table.csv", row.names = TRUE)

# Taxonomic assignment using SILVA v138
taxa <- assignTaxonomy(
  seqtab.nochim,
  "/path_to_silva_database/silva_nr_v138_train_set.fa.gz",
  multithread = TRUE
)

write.csv(taxa, "taxa_table.csv", quote = FALSE)

# Save final objects
saveRDS(seqtab.nochim, "seqtab_final.rds")
saveRDS(taxa, "taxa_final.rds")
save.image("dada2_environment.RData")


