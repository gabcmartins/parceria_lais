library(phyloseq)
library(ggplot2)
library(Biostrings)
library(pairwiseAdonis)

# Load DADA2 results
load("R_enviroment_with_dada2_results")

# Load metadata
samdf <- read.csv(
  "/path_to_metadata/metadata_dada2.tsv",
  sep = "\t",
  row.names = "sample.id"
)

# Ensure sample name consistency
rownames(seqtab.nochim) <- sample.names
all(rownames(samdf) %in% rownames(seqtab.nochim))

# Build phyloseq object
ps <- phyloseq(
  otu_table(seqtab.nochim, taxa_are_rows = FALSE),
  sample_data(samdf),
  tax_table(taxa)
)

# Add DNA sequences to phyloseq object
dna <- DNAStringSet(taxa_names(ps))
names(dna) <- taxa_names(ps)
ps <- merge_phyloseq(ps, dna)

# Rename ASVs
taxa_names(ps) <- paste0("ASV", seq(ntaxa(ps)))

# Inspect sequencing depth
sample_sums(ps)

# Evaluate rarefaction thresholds
cutoffs <- c(93000, 95000, 97000, 100000)
sapply(cutoffs, function(x) sum(sample_sums(ps) >= x))

# Rarefaction curves
otu <- as.data.frame(otu_table(ps))
rarecurve(otu, step = 100)

# Rarefy to even sequencing depth
ps_rare <- rarefy_even_depth(
  ps,
  rngseed = 1170,
  sample.size = 93000,
  replace = FALSE,
  verbose = TRUE
)

# Alpha diversity visualization
plot_richness(
  ps_rare,
  x = "group",
  measures = c("Shannon", "Simpson")
) + geom_boxplot()

# Alpha diversity estimates
rich <- estimate_richness(ps_rare, measures = c("Shannon", "Simpson"))

# Pairwise comparisons for alpha diversity 
pairwise.wilcox.test(rich$Shannon, sample_data(ps_rare)$group)
pairwise.wilcox.test(rich$Simpson, sample_data(ps_rare)$group)

# Beta diversity: Bray–Curtis PCoA
ord.pcoa.bray <- ordinate(ps_rare, method = "PCoA", distance = "bray")

df_plot <- as.data.frame(ord.pcoa.bray$vectors[, 1:2])
colnames(df_plot) <- c("Axis.1", "Axis.2")
df_plot$group <- as.character(sample_data(ps_rare)$group)

# Variance explained
var_exp <- ord.pcoa.bray$values$Relative_eig
pc1 <- round(var_exp[1] * 100, 1)
pc2 <- round(var_exp[2] * 100, 1)

# PCoA plot
pcoa_plot <- ggplot(df_plot, aes(x = Axis.1, y = Axis.2, fill = group)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray", alpha = 0.6) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray", alpha = 0.6) +
  geom_point(size = 5, shape = 21, color = "black", stroke = 0.8) +
  theme_bw() +
  labs(
    title = "PCoA (Bray–Curtis)",
    x = paste0("PCoA1 (", pc1, "%)"),
    y = paste0("PCoA2 (", pc2, "%)"),
    fill = "Group"
  ) +
  theme(
    legend.position = c(1, 1),
    legend.justification = c("right", "top"),
    legend.background = element_rect(fill = "white", color = "black", linewidth = 0.1),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  )

ggsave("pcoa_bray_beta_diversity.png", pcoa_plot, width = 8, height = 6, dpi = 300)

# Beta diversity statistics (PERMANOVA)
dist.bray <- phyloseq::distance(ps_rare, method = "bray")

meta <- read.table(
  "/path_to_metadata/metadata_dada2.tsv",
  header = TRUE,
  sep = "\t",
  row.names = 1,
  stringsAsFactors = FALSE
)

all(sample_names(ps_rare) %in% rownames(meta))

adonis2(dist.bray ~ group, data = meta, permutations = 9999)

# Test homogeneity of group dispersions
bd <- betadisper(dist.bray, meta$group)
anova(bd)

# Pairwise PERMANOVA for beta diversity
pairwise.adonis(
  dist.bray,
  factors = meta$group,
  perm = 9999,
  p.adjust.m = "BH"
)

# Relative abundance barplots at different taxonomic levels

# Phylum level
ps.phylum <- tax_glom(ps, taxrank = "Phylum", NArm = FALSE)
ps_rel2 <- transform_sample_counts(ps.phylum, function(x) x / sum(x))

phylum.top5 <- names(sort(taxa_sums(ps_rel2), decreasing = TRUE)[1:5])
phylum_top5 <- ps_rel2
tax_table(phylum_top5)[!taxa_names(phylum_top5) %in% phylum.top5, "Phylum"] <- "Others"

df_bar_phylum <- psmelt(phylum_top5)

cores_accent2 <- c(RColorBrewer::brewer.pal(5, "Accent"), "gray80")

df_bar_phylum$Phylum <- as.factor(df_bar_phylum$Phylum)
df_bar_phylum$Phylum <- fct_relevel(df_bar_phylum$Phylum, "Others", after = Inf)

ggplot(df_bar_phylum, aes(x = Sample, y = Abundance, fill = Phylum)) +
  geom_bar(stat = "identity", position = "stack") +
  facet_wrap(~group, scales = "free_x", nrow = 1) +
  scale_fill_manual(values = cores_accent2) +
  theme_bw() +
  labs(y = "Relative abundance", x = "") +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1),
    legend.position = "right",
    strip.background = element_rect(fill = "gray90", color = NA)
  )

ggsave("stacked_barplot_phylum.png", width = 8, height = 6, dpi = 300)

# Class level
ps.class <- tax_glom(ps, taxrank = "Class", NArm = FALSE)

ps_rel <- transform_sample_counts(ps.class, function(x) x / sum(x))
top5 <- names(sort(taxa_sums(ps_rel), decreasing = TRUE)[1:5])

ps_top5 <- ps_rel
tax_table(ps_top5)[!taxa_names(ps_top5) %in% top5, "Class"] <- "Others"

df_bar <- psmelt(ps_top5)

cores_accent <- c(RColorBrewer::brewer.pal(5, "Accent"), "gray80")

ggplot(df_bar, aes(x = Sample, y = Abundance, fill = Class)) +
  geom_bar(stat = "identity", position = "stack") +
  facet_wrap(~group, scales = "free_x", nrow = 1) +
  scale_fill_manual(values = cores_accent) +
  theme_bw() +
  labs(y = "Relative abundance", x = "") +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1),
    legend.position = "right",
    strip.background = element_rect(fill = "gray90", color = NA)
  )

ggsave("stacked_barplot_class.png", width = 8, height = 6, dpi = 300)

# Order level
ps.order <- tax_glom(ps, taxrank = "Order", NArm = FALSE)

ps_rel3 <- transform_sample_counts(ps.order, function(x) x / sum(x))
order.top5 <- names(sort(taxa_sums(ps_rel3), decreasing = TRUE)[1:5])

order_top5 <- ps_rel3
tax_table(order_top5)[!taxa_names(order_top5) %in% order.top5, "Order"] <- "Others"

df_bar_order <- psmelt(order_top5)

cores_accent3 <- c(RColorBrewer::brewer.pal(5, "Set3"), "gray80")

ggplot(df_bar_order, aes(x = Sample, y = Abundance, fill = Order)) +
  geom_bar(stat = "identity", position = "stack") +
  facet_wrap(~group, scales = "free_x", nrow = 1) +
  scale_fill_manual(values = cores_accent3) +
  theme_bw() +
  labs(y = "Relative abundance", x = "") +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1),
    legend.position = "right",
    strip.background = element_rect(fill = "gray90", color = NA)
  )

ggsave("stacked_barplot_order2.png", width = 8, height = 6, dpi = 300)

# Differential abundance analysis using ANCOM-BC
# Taxonomic level: Family

load("/media/Data/gabicas/resultados_vanessa_gabi/dada2/meu_ambiente_lais.RData")
ls()

library(ANCOMBC)
library(tidyverse)
library(ggplot2)
library(dplyr)
library(stringr)

# Run ANCOM-BC
out <- ancombc(
  data = ps,
  tax_level = "Family",
  formula = "group",
  group = "group"
)

res <- out$res

# Export ANCOM-BC results
tab_lfc <- res$lfc
col_name <- c("Taxon", "Intercept", "KO_Il1a", "KO_Il1aR")
colnames(tab_lfc) <- col_name
write_xlsx(tab_lfc, "Resultados_ANCOM_LFC.xlsx")

tab_se <- res$se
colnames(tab_se) <- col_name
write_xlsx(tab_se, "Resultados_ANCOM_SE.xlsx")

tab_w <- res$W
colnames(tab_w) <- col_name
write_xlsx(tab_w, "Resultados_ANCOM_w_Test_Statistics.xlsx")

tab_p <- res$p_val
colnames(tab_p) <- col_name
write_xlsx(tab_p, "Resultados_ANCOM_p_values.xlsx")

tab_q <- res$q
colnames(tab_q) <- col_name
write_xlsx(tab_q, "Resultados_ANCOM_q_values.xlsx")

tab_diff <- res$diff_abn
colnames(tab_diff) <- col_name
write_xlsx(tab_diff, "Resultados_ANCOM_diff_tax.xlsx")

# Horizontal barplot of log fold change (IL-1α KO vs Control)

# Prepare data
df_lfc <- as.data.frame(out$res$lfc)
df_se  <- as.data.frame(out$res$se)
df_sig <- as.data.frame(out$res$diff_abn)

# Merge results and filter significant taxa
df_fig_il1a <- df_lfc %>%
  select(taxon, lfc_val = `groupknockout-IL1a`) %>%
  inner_join(df_se %>% select(taxon, se_val = `groupknockout-IL1a`), by = "taxon") %>%
  inner_join(df_sig %>% select(taxon, is_sig = `groupknockout-IL1a`), by = "taxon") %>%
  filter(is_sig == TRUE & lfc_val != 0)

# Extract family names and apply manual taxonomic annotation
df_fig_il1a <- df_fig_il1a %>%
  mutate(
    Family = str_remove(taxon, "Family:"),
    Family = str_trim(Family)
  ) %>%
  # Exclude selected taxa based on biological relevance
  filter(!str_detect(Family, "(?i)Firmicutes|Coriobacteriales")) %>%
  # Manual phylum assignment (phylum not provided by ANCOM-BC output)
  mutate(Phylum = case_when(
    Family %in% c("Peptococcaceae", "Ruminococcaceae", "Lachnospiraceae",
                  "Oscillospiraceae", "Christensenellaceae", "Staphylococcaceae",
                  "Acholeplasmataceae") ~ "Firmicutes",
    Family %in% c("Tannerellaceae", "Rikenellaceae", "Prevotellaceae") ~ "Bacteroidetes",
    Family %in% c("Helicobacteraceae", "Sutterellaceae") ~ "Proteobacteria",
    Family %in% c("Atopobiaceae", "Bifidobacteriaceae") ~ "Actinobacteria",
    Family == "Saccharimonadaceae" ~ "Patescibacteria",
    TRUE ~ "Unclassified"
  )) %>%
  arrange(lfc_val)

# Plot significant taxa
if (nrow(df_fig_il1a) > 0) {

  df_fig_il1a$Family <- factor(df_fig_il1a$Family, levels = df_fig_il1a$Family)

  p <- ggplot(df_fig_il1a, aes(x = Family, y = lfc_val, fill = Phylum)) +
    geom_bar(stat = "identity", color = "black", width = 0.7, size = 0.3) +
    geom_errorbar(
      aes(ymin = lfc_val - se_val, ymax = lfc_val + se_val),
      width = 0.2, color = "black", size = 0.4
    ) +
    coord_flip() +
    theme_bw() +
    scale_fill_brewer(palette = "Set2") +
    labs(
      title = "Differential taxon abundance: IL-1α KO vs Control",
      subtitle = "Significant families (Holm-adjusted p < 0.05)",
      x = "Bacterial family",
      y = "Log fold change (LFC)",
      fill = "Phylum"
    ) +
    theme(
      plot.title = element_text(face = "bold", size = 14),
      axis.text.y = element_text(face = "italic", size = 10),
      axis.title = element_text(size = 12),
      legend.position = "right",
      panel.grid.major.y = element_blank()
    )

  print(p)
  ggsave("Barplot_ANCOM_Family_Level.png", p, width = 10, height = 8, dpi = 600)

} else {
  print("Warning: No significant taxa detected after filtering.")
}

# ============================================================
# Genus level analysis
# ============================================================

library(ANCOMBC)
library(tidyverse)
library(writexl)

# Run ANCOM-BC
out_genus = ancombc(
  data = ps,
  tax_level = "Genus",
  formula = "group",
  group = "group"
)

res_genus = out_genus$res

# Export results
tab_lfc_genus = res_genus$lfc
colnames(tab_lfc_genus) = col_name
write_xlsx(tab_lfc_genus, "Resultados_ANCOM_LFC_Genus.xlsx")

tab_se_genus = res_genus$se
colnames(tab_se_genus) = col_name
write_xlsx(tab_se_genus, "Resultados_ANCOM_SE_Genus.xlsx")

tab_w_genus = res_genus$W
colnames(tab_w_genus) = col_name
write_xlsx(tab_w_genus, "Resultados_ANCOM_w_Test_Statistics_Genus.xlsx")

tab_p_genus = res_genus$p_val
colnames(tab_p_genus) = col_name
write_xlsx(tab_p_genus, "Resultados_ANCOM_p_values_Genus.xlsx")

tab_q_genus = res_genus$q
colnames(tab_q_genus) = col_name
write_xlsx(tab_q_genus, "Resultados_ANCOM_q_values_Genus.xlsx")

tab_diff_genus = res_genus$diff_abn
colnames(tab_diff_genus) = col_name
write_xlsx(tab_diff_genus, "Resultados_ANCOM_diff_tax_Genus.xlsx")

# -------------------------
# Volcano plot: Genus level
# -------------------------

library(ggplot2)
library(ggrepel)
library(phyloseq)
library(stringr)
library(dplyr)

# Extract taxonomy from phyloseq
tax_ref = as.data.frame(tax_table(ps)) %>%
  select(Phylum, Genus) %>%
  distinct() %>%
  mutate(
    Genus_Clean = str_trim(str_remove(Genus, ".*g__")),
    Phylum = str_replace_na(str_remove(Phylum, ".*p__"), "Unclassified")
  )

# Prepare volcano data
df_volcano = tab_lfc_genus %>%
  select(Taxon, lfc = KO_Il1a) %>%
  inner_join(tab_q_genus %>% select(Taxon, q_val = KO_Il1a), by = "Taxon") %>%
  mutate(
    q_val = ifelse(q_val == 0, 1e-300, q_val),
    log_q = -log10(q_val),
    Genus_Clean = str_trim(str_remove(Taxon, ".*[Gg]enus:|.*g__"))
  )

# Join taxonomy
df_volcano_final = df_volcano %>%
  left_join(tax_ref, by = "Genus_Clean") %>%
  mutate(Phylum = ifelse(is.na(Phylum), "Other", Phylum))

# Labeling and significance
df_volcano_final = df_volcano_final %>%
  mutate(
    Label_Name = ifelse(log_q > 25 & q_val < 0.05, Genus_Clean, NA),
    Is_Sig = ifelse(q_val < 0.05, "Significant", "NS")
  )

# Plot
p_volcano = ggplot(df_volcano_final, aes(x = lfc, y = log_q, color = Phylum)) +
  geom_point(aes(alpha = Is_Sig), size = 3) +
  scale_alpha_manual(values = c("Significant" = 0.85, "NS" = 0.2)) +
  scale_color_brewer(palette = "Paired") +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "gray50") +
  geom_vline(xintercept = 0, color = "black", alpha = 0.3) +
  geom_text_repel(
    aes(label = Label_Name),
    size = 3.5,
    fontface = "italic",
    box.padding = 0.6,
    max.overlaps = Inf,
    show.legend = FALSE
  ) +
  theme_bw() +
  labs(
    title = "Volcano plot: differential genus abundance",
    subtitle = "Colored by phylum (phyloseq taxonomy)",
    x = "Log fold change (LFC)",
    y = "-log10 (adjusted p-value)",
    color = "Phylum"
  ) +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    legend.position = "right"
  )

print(p_volcano)
ggsave("Volcano_Plot_Genus_Phyloseq_Colors.png", p_volcano, width = 11, height = 8, dpi = 600)

# Generating heatmap of genus-level abundance (ANCOM-BC bias-corrected)

# --- LOAD LIBRARIES ---
library(tidyverse)
library(ComplexHeatmap)
library(circlize)
library(stringr)

# --- SAMPLE METADATA FOR ANNOTATION ---
anno_col = as.data.frame(sample_data(ps))

# Ensure grouping column is named 'Group'
# colnames(anno_col)[colnames(anno_col) == "condition"] <- "Group"

# --- 1. BIAS-CORRECTED ABUNDANCE CALCULATION ---
samp_frac = out_genus$samp_frac
samp_frac[is.na(samp_frac)] = 0

log_obs_abn = log(out_genus$feature_table + 1)
log_corr_abn = t(t(log_obs_abn) - samp_frac)

# --- 2. FILTER SAMPLES AND GROUPS ---
samples_to_keep = rownames(anno_col)[
  anno_col$Group %in% c("controle", "knockout-IL1a")
]

anno_col_filt = anno_col[samples_to_keep, , drop = FALSE]

anno_col_filt$Group_Labels = factor(
  anno_col_filt$Group,
  levels = c("controle", "knockout-IL1a"),
  labels = c("Control", "IL1\u03b1 -/-")
)

# --- 3. FILTER SIGNIFICANT GENERA ---
sig_taxa_clean = df_volcano_final %>%
  filter(q_val < 0.05) %>%
  filter(!str_detect(Taxon, "^Phylum:|^Class:|^Order:|^Family:|^f__")) %>%
  pull(Taxon)

mat_final = log_corr_abn[sig_taxa_clean, samples_to_keep]

rownames(mat_final) = rownames(mat_final) %>%
  str_remove(".*[Gg]enus:") %>%
  str_remove(".*g__") %>%
  str_trim()

# --- 4. HEATMAP CONFIGURATION ---
col_fun = colorRamp2(
  c(min(mat_final), 0, max(mat_final)),
  c("blue", "white", "red")
)

h_final = Heatmap(
  mat_final,
  name = "Log Corr.\nAbundance",
  col = col_fun,

  cluster_rows = TRUE,
  show_row_dend = FALSE,
  row_names_gp = gpar(fontitalic = TRUE, fontsize = 9),

  cluster_columns = FALSE,
  show_column_names = FALSE,
  column_split = anno_col_filt$Group_Labels,
  column_title_gp = gpar(fontsize = 12, fontface = "bold"),

  heatmap_legend_param = list(
    title_gp = gpar(fontsize = 10, fontface = "bold")
  )
)

# --- 5. EXPORT FIGURES ---
cairo_pdf("Heatmap_IL1a_Genera.pdf", width = 8, height = 10)
draw(h_final)
dev.off()

png("Heatmap_IL1a_Genera.png", width = 1000, height = 1200, res = 150)
draw(h_final)
dev.off()

